####commands for ami installation #############
yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
yum install -y dnf-utils http://rpms.remirepo.net/enterprise/remi-release-8.rpm
yum module reset php -y
yum module enable php:remi-7.4 -y
yum install -y php php-common php-mbstring php-opcache php-intl php-xml php-gd php-curl php-mysqlnd php-fpm php-json
systemctl start php-fpm
systemctl enable php-fpm
yum install wget vim python3 telnet htop git mysql chrony -y
systemctl start chronyd
systemctl status chronyd
systemctl enable chronyd
git clone https://github.com/aws/efs-utils
cd /efs-utils
yum install -y make
yum install -y rpm-build
make rpm 
yum install -y  ./build/amazon-efs-utils*rpm
setsebool -P httpd_can_network_connect=1
setsebool -P httpd_can_network_connect_db=1
setsebool -P httpd_execmem=1
setsebool -P httpd_use_nfs 1

## seting up self-signed certificate fro the instance
yum install -y mod_ssl
systemctl restart httpd
openssl req -newkey rsa:2048 -nodes -keyout /etc/pki/tls/private/ACS.key -x509 -days 365 -out /etc/pki/tls/certs/ACS.crt
 vi /etc/httpd/conf.d/ssl.conf
  systemctl reload httpd

openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/ACS.key -out /etc/ssl/certs/ACS.crt





# Creating database users for wordpress and tooling
CREATE USER 'wordpress'@'192.168.1.0/24' IDENTIFIED WITH mysql_native_password BY 'w0rdpr33';
GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpress'@'192.168.1.0/24' WITH GRANT OPTION;
FLUSH PRIVILEGES;

CREATE USER 'wordpress'@'192.168.3.0/24' IDENTIFIED WITH mysql_native_password BY 'w0rdpr33';
GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpress'@'192.168.3.0/24' WITH GRANT OPTION;
FLUSH PRIVILEGES;

CREATE USER 'tooling'@'192.168.1.0/24' IDENTIFIED WITH mysql_native_password BY 't00l!n#';
GRANT ALL PRIVILEGES ON tooling.* TO 'tooling'@'192.168.1.0/24' WITH GRANT OPTION;
FLUSH PRIVILEGES;

CREATE USER 'tooling'@'192.168.3.0/24' IDENTIFIED WITH mysql_native_password BY 't00l!n#';
GRANT ALL PRIVILEGES ON tooling.* TO 'tooling'@'192.168.3.0/24' WITH GRANT OPTION;
FLUSH PRIVILEGES;


# creating wordpress and tooling database
CREATE DATABASE toolingdb;
CREATE DATABASE wordpressdb;


listen       80;
        server_name  oyindamola.gq;



  listen 443 http2 ssl;
    listen [::]:443 http2 ssl;

    server_name  oyindamola.gq;

    ssl_certificate /etc/ssl/certs/ACS.crt;
    ssl_certificate_key /etc/ssl/private/ACS.key;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;